name: GAC 自动重置积分

# 触发器
on:
  # 定时触发（每天北京时间 23:57 = UTC 15:57）
  schedule:
    - cron: "57 15 * * *"

  # 允许手动触发
  workflow_dispatch:

jobs:
  reset-credits:
    runs-on: ubuntu-latest
    name: 自动重置积分

    steps:
      # 1. 检查代码
      - name: 检查代码
        uses: actions/checkout@v4

      # 2. 安装Python
      - name: 安装 Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: "pip"

      # 3. 安装依赖
      - name: 安装依赖
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 4. 创建动态配置文件
      - name: 创建配置文件
        run: |
          cat > config_github_actions.json << EOF
          {
            "auth_token": "${{ secrets.GAC_AUTH_TOKEN }}",
            "email": "${{ secrets.GAC_EMAIL }}",
            "password": "${{ secrets.GAC_PASSWORD }}",
            "base_url": "https://gaccode.com/api",
            "ticket_config": {
              "category_id": 3,
              "title": "重置积分",
              "description": "",
              "language": "zh"
            },
            "retry_config": {
              "max_retries": 3,
              "retry_delay": 2
            },
            "email_alerts": {
              "enabled": true,
              "smtp_server": "${{ secrets.SMTP_SERVER }}",
              "smtp_port": ${{ secrets.SMTP_PORT }},
              "smtp_user": "${{ secrets.SMTP_USER }}",
              "smtp_password": "${{ secrets.SMTP_PASSWORD }}",
              "from_email": "${{ secrets.FROM_EMAIL }}",
              "to_email": "${{ secrets.TO_EMAIL }}",
              "on_failure": true,
              "on_success": false,
              "on_token_refresh": true
            }
          }
          EOF

      # 5. 运行重置脚本
      - name: 运行积分重置
        id: reset
        continue-on-error: true
        run: |
          echo "开始执行积分重置..."
          python auto_reset_credits_advanced.py --config config_github_actions.json --check-balance
          echo "reset_status=$?" >> $GITHUB_OUTPUT

      # 6. 清理配置文件
      - name: 清理敏感配置文件
        if: always()
        run: |
          rm -f config_github_actions.json

      # 7. 运行失败时发送邮件
      - name: 发送失败通知邮件
        if: failure()
        run: |
          python3 << 'EOF'
          import smtplib
          import os
          from email.mime.text import MIMEText
          from email.mime.multipart import MIMEMultipart
          from email.header import Header
          from datetime import datetime

          try:
              msg = MIMEMultipart()
              msg['From'] = os.environ.get('FROM_EMAIL')
              msg['To'] = os.environ.get('TO_EMAIL')
              msg['Subject'] = Header('[GAC积分重置工具] ❌ GitHub Actions 执行失败', 'utf-8')
              
              body = f"""
          GAC积分重置工具通知

          时间: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')} UTC
          类型: error

          GitHub Actions 任务执行失败！

          工作流: GAC 自动重置积分
          运行ID: {os.environ.get('GITHUB_RUN_ID')}
          状态: 失败 ❌

          请检查详细日志:
          {os.environ.get('GITHUB_SERVER_URL')}/{os.environ.get('GITHUB_REPOSITORY')}/actions/runs/{os.environ.get('GITHUB_RUN_ID')}

          可能的原因:
          - 网络连接问题
          - 认证token过期
          - 今日已重置
          - 订阅状态异常

          ---
          此邮件由GitHub Actions自动发送
          仓库: {os.environ.get('GITHUB_REPOSITORY')}
          """
              
              msg.attach(MIMEText(body, 'plain', 'utf-8'))
              
              smtp_server = os.environ.get('SMTP_SERVER')
              smtp_port = int(os.environ.get('SMTP_PORT'))
              
              if smtp_port == 465:
                  server = smtplib.SMTP_SSL(smtp_server, smtp_port, timeout=30)
              else:
                  server = smtplib.SMTP(smtp_server, smtp_port, timeout=30)
                  server.starttls()
              
              server.login(os.environ.get('SMTP_USER'), os.environ.get('SMTP_PASSWORD'))
              server.sendmail(os.environ.get('FROM_EMAIL'), [os.environ.get('TO_EMAIL')], msg.as_string())
              server.quit()
              
              print("失败通知邮件发送成功")
          except Exception as e:
              print(f"发送失败通知邮件出错: {e}")
              import traceback
              traceback.print_exc()
          EOF
        env:
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
          TO_EMAIL: ${{ secrets.TO_EMAIL }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      # 8. 上传日志（可选）
      - name: 上传执行日志
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: reset-logs-${{ github.run_id }}
          path: |
            *.log
          retention-days: 7
          if-no-files-found: ignore
